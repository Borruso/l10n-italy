<?xml version="1.0" encoding="utf-8" ?>
<!--
  ~ Copyright 2022 Simone Rubino - TAKOBI
  ~ License AGPL-3.0 or later (https://www.gnu.org/licenses/agpl).
  -->
<odoo>
    <template
        id="account_invoice_it_dati_ddt"
        inherit_id="l10n_it_fatturapa_out.account_invoice_it_dati_ddt"
    >
            <xpath expr="t" position="replace">
                <t t-set="related_dns" t-value="record.related_documents.browse()" />
                <t
                t-foreach="record.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"
                t-as="line"
            >
                    <t
                    t-foreach="line.related_documents.filtered(lambda doc: doc.type == 'dn_data')"
                    t-as="doc"
                >
                        <t t-set="related_dns" t-value="related_dns + doc" />
                    </t>
                </t>
                <t
                t-set="related_dns"
                t-value="related_dns + record.related_documents.filtered(lambda doc: doc.type == 'dn_data')"
            />
                <!--2.1.8-->
                <DatiDDT t-foreach="related_dns" t-as="doc">
                    <NumeroDDT t-if="doc.name" t-esc="doc.name" />
                    <DataDDT t-if="doc.date" t-esc="doc.date" />
                    <RiferimentoNumeroLinea t-if="doc.lineRef" t-esc="doc.lineRef" />
                </DatiDDT>
            </xpath>
        </template>
</odoo>
